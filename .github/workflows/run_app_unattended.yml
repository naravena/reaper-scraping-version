name: Run Web Scraping Unattended

on:
  schedule:
    - cron: '0 20,8 * * *'  # Ejecutar a las 8 PM y a las 8 AM, hora de España

jobs:
  run_scraping_unattended:

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run web scraping script
        id: scraping
        run: python core.py

      - name: Send WhatsApp message if version updated
        if: steps.scraping.outputs.stdout == '¡La versión se ha actualizado!'
        run: |
                  python - <<EOF
                  from twilio.rest import Client
                  
                  # Configuración de la cuenta de Twilio
                  account_sid = '${{ secrets.TWILIO_ACCOUNT_SID }}'
                  auth_token = '${{ secrets.TWILIO_AUTH_TOKEN }}'
                  twilio_phone_number = '${{ secrets.TWILIO_PHONE_NUMBER }}'
        
                  # Configuración del número de teléfono de destino
                  whatsapp_phone_number = 'whatsapp:${{ secrets.WHATSAPP_PHONE_NUMBER }}'  # Número de teléfono de prueba de WhatsApp de Twilio
        
                  # Mensaje que quieres enviar
                  mensaje = "${MESSAGE}"
        
                  # Crear el cliente de Twilio
                  client = Client(account_sid, auth_token)
        
                  try:
                      # Enviar el mensaje de WhatsApp
                      message = client.messages.create(
                                                        body=mensaje,
                                                        from_=twilio_phone_number,
                                                        to=whatsapp_phone_number
                                                    )
        
                      print("Mensaje enviado correctamente a:", message.to)
                  except Exception as e:
                      print("Se produjo un error al enviar el mensaje:", str(e))
                  EOF
